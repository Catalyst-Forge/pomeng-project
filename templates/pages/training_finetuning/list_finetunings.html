{% extends "dashboard.html" %} {% block content %}
<section class="bg-light mt-5">
    <div class="container-fluid px-4">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h2 class="h3 mb-0">Fine-Tuning Jobs</h2>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createFinetuningModal">
                    <i class="bi bi-plus-circle me-2"></i>Create Fine-tuning Job
                </button>
            </div>
        </div>

        {% if success_message %}
        <div class="alert alert-success alert-dismissible fade show shadow-sm">
            <i class="bi bi-check-circle me-2"></i>{{ success_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %} {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show shadow-sm">
            <i class="bi bi-exclamation-circle me-2"></i>{{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %} {% if finetunings %}
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Job ID</th>
                                <th>Base Model</th>
                                <th>Fine-Tuned Model</th>
                                <th>Trained Tokens</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Created At</th>
                                <th>Finished At</th>
                                <th class="text-end px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for finetuning in finetunings %}
                            <tr>
                                <td class="px-4">{{ finetuning.id }}</td>
                                <td class="px-4">{{ finetuning.data.base_model }}</td>
                                <td>{{ finetuning.data.fine_tuned_model }}</td>
                                <td>{{ finetuning.data.trained_tokens }}</td>
                                <td>
                                    <span
                                        class="badge {% if finetuning.data.status == 'succeeded' %}bg-success {% elif finetuning.data.status == 'running' %}bg-primary {% elif finetuning.data.status == 'validating_files' %}bg-info {% elif finetuning.data.status == 'queued' %}bg-secondary {% elif finetuning.data.status == 'failed' %}bg-danger {% elif finetuning.data.status == 'cancelled' %}bg-warning {% else %}bg-light text-dark{% endif %}"
                                    >
                                        {{ finetuning.data.status.replace('_', ' ') | title }}
                                    </span>
                                </td>
                                <td style="min-width: 200px">
                                    {% if finetuning.data.status in ['validating_files', 'queued', 'running'] %}
                                    <div class="progress" style="height: 10px">
                                        <div
                                            class="progress-bar progress-bar-striped {% if finetuning.data.status == 'validating_files' %}bg-info {% elif finetuning.data.status == 'queued' %}bg-secondary {% elif finetuning.data.status == 'running' %} {% if finetuning.data.progress < 30 %}bg-danger {% elif finetuning.data.progress < 70 %}bg-warning {% else %}bg-success{% endif %} {% endif %} {% if finetuning.data.status in ['validating_files', 'queued'] %}progress-bar-animated{% endif %}"
                                            role="progressbar"
                                            style="width: {% if finetuning.data.status == 'validating_files' %}30%
                                                    {% elif finetuning.data.status == 'queued' %}60%
                                                    {% else %}{{ finetuning.data.progress }}%{% endif %};"
                                            aria-valuenow="{% if finetuning.data.status == 'validating_files' %}30
                                                    {% elif finetuning.data.status == 'queued' %}60
                                                    {% else %}{{ finetuning.data.progress }}{% endif %}"
                                            aria-valuemin="0"
                                            aria-valuemax="100"
                                        >
                                            {{ finetuning.data.progress }}%
                                        </div>
                                    </div>
                                    {% else %} - {% endif %}
                                </td>
                                <td>{{ finetuning.data.created_at }}</td>
                                <td>{{ finetuning.data.finished_at or '-' }}</td>
                                <td class="text-end px-4">
                                    <div class="btn-group">
                                        <button
                                            class="btn btn-outline-primary btn-sm"
                                            onclick="loadDetails('{{ finetuning.id }}')"
                                            title="View Details"
                                        >
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button
                                            class="btn btn-outline-info btn-sm"
                                            onclick="showSteps('{{ finetuning.id }}')"
                                            {%
                                            if
                                            not
                                            finetuning.data.result_files
                                            or
                                            finetuning.data.status
                                            !="succeeded"
                                            %}disabled{%
                                            endif
                                            %}
                                            title="Show Steps"
                                        >
                                            <i class="bi bi-graph-up"></i>
                                        </button>
                                        <a
                                            href="{{ url_for('train_finetuning.show_metrics', fine_tuning_id=finetuning.id) }}"
                                            class="btn btn-outline-success btn-sm {% if not finetuning.data.result_files or finetuning.data.status != 'succeeded' %}disabled{% endif %}"
                                            title="Show Metrics"
                                        >
                                            <i class="bi bi-bar-chart"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 2rem"></i>
                <p class="h5 mt-3 text-muted">No fine-tuning jobs found</p>
                <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#createFinetuningModal">
                    <i class="bi bi-plus-circle me-2"></i>Create Your First Job
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Details Modal -->
        <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Fine-Tuning Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalContent"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Steps Modal -->
        <div class="modal fade" id="stepsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-graph-up me-2"></i>Training Per Steps</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="stepsContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/finetuning.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% include 'pages/training_finetuning/create-finetunings-jobs.html' %}
</section>
{% endblock %}
