<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="/static/css/modal-style-finetuning.css" />
        <script src="/static/js/metrics-modal.js" defer></script>
    </head>
    <body>
        <div class="steps-container">
            <div class="steps-header">
                <h3>Fine-Tuning Metrics</h3>
                <h4>Job ID: {{ fine_tuning_id }}</h4>
            </div>

            {% if metrics and metrics.get('data_points', 0) > 0 %}
            <div class="summary-stats">
                {% if metrics.get('avg_train_loss') is not none %}
                <div class="stat-card">
                    <div class="stat-label">Average Training Loss</div>
                    <div class="stat-value">{{ "%.6g"|format(metrics['avg_train_loss']) }}</div>
                </div>
                {% endif %} {% if metrics.get('avg_valid_loss') is not none %}
                <div class="stat-card">
                    <div class="stat-label">Average Validation Loss</div>
                    <div class="stat-value">{{ "%.6g"|format(metrics['avg_valid_loss']) }}</div>
                </div>
                {% endif %} {% if metrics.get('max_train_accuracy') is not none %}
                <div class="stat-card">
                    <div class="stat-label">Max Training Accuracy</div>
                    <div class="stat-value">{{ "%.2f%%"|format(metrics['max_train_accuracy'] * 100) }}</div>
                </div>
                {% endif %} {% if metrics.get('max_valid_accuracy') is not none %}
                <div class="stat-card">
                    <div class="stat-label">Max Validation Accuracy</div>
                    <div class="stat-value">{{ "%.2f%%"|format(metrics['max_valid_accuracy'] * 100) }}</div>
                </div>
                {% endif %}
            </div>

            <div class="table-container">
                <table class="metrics-table">
                    <thead>
                        <tr>
                            <th>Step</th>
                            <th>Training Loss</th>
                            <th>Validation Loss</th>
                            <th>Training Accuracy</th>
                            <th>Validation Accuracy</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(metrics['step']|length) %}
                        <tr>
                            <td>{{ metrics['step'][i] if metrics['step'][i] is not none else 'N/A' }}</td>
                            <td>
                                {% if metrics['train_loss'] and metrics['train_loss'][i] is not none %} {{
                                "%.6g"|format(metrics['train_loss'][i]) }} {% else %} N/A {% endif %}
                            </td>
                            <td>
                                {% if metrics['valid_loss'] and metrics['valid_loss'][i] is not none %} {{
                                "%.6g"|format(metrics['valid_loss'][i]) }} {% else %} N/A {% endif %}
                            </td>
                            <td>
                                {% if metrics['train_accuracy'] and metrics['train_accuracy'][i] is not none %} {{
                                "%.2f%%"|format(metrics['train_accuracy'][i] * 100) }} {% else %} N/A {% endif %}
                            </td>
                            <td>
                                {% if metrics['valid_mean_token_accuracy'] and metrics['valid_mean_token_accuracy'][i] is not none %} {{
                                "%.2f%%"|format(metrics['valid_mean_token_accuracy'][i] * 100) }} {% else %} N/A {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages and total_pages > 1 %}
            <div class="pagination">
                {% if current_page > 1 %}
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', 1); return false;" class="page-link">&laquo; First</a>
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', {{ current_page-1 }}); return false;" class="page-link"
                    >Previous</a
                >
                {% endif %} {% set window_size = 5 %} {% set window_start = [(current_page - (window_size//2)), 1]|max %} {% set window_end
                = [(window_start + window_size - 1), total_pages]|min %} {% set window_start = [(window_end - window_size + 1), 1]|max %} {%
                if window_start > 1 %}
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', 1); return false;" class="page-link">1</a>
                {% if window_start > 2 %}
                <span class="page-ellipsis">...</span>
                {% endif %} {% endif %} {% for p in range(window_start, window_end + 1) %}
                <a
                    href="#"
                    onclick="loadStepsPage('{{ fine_tuning_id }}', {{ p }}); return false;"
                    class="page-link {{ 'active' if p == current_page else '' }}"
                    >{{ p }}</a
                >
                {% endfor %} {% if window_end < total_pages %} {% if window_end < total_pages - 1 %}
                <span class="page-ellipsis">...</span>
                {% endif %}
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', {{ total_pages }}); return false;" class="page-link"
                    >{{ total_pages }}</a
                >
                {% endif %} {% if current_page < total_pages %}
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', {{ current_page+1 }}); return false;" class="page-link">Next</a>
                <a href="#" onclick="loadStepsPage('{{ fine_tuning_id }}', {{ total_pages }}); return false;" class="page-link"
                    >Last &raquo;</a
                >
                {% endif %}
            </div>
            {% endif %} {% else %}
            <div class="alert alert-warning">
                No metrics data available. Please check if the fine-tuning job has started generating metrics.
            </div>
            {% endif %}
        </div>
    </body>
</html>
