<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Model Management</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
        <style>
            .model-status {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
            }
            .status-active {
                background-color: #dcfce7;
                color: #166534;
            }
            .status-inactive {
                background-color: #f3f4f6;
                color: #374151;
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="p-4">
            <!-- Header with Create Button -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Model Management</h2>
                <button
                    data-modal-target="createModelModal"
                    data-modal-toggle="createModelModal"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                    Create Model
                </button>
            </div>

            <!-- Alert for messages -->
            <div id="alert-container" class="hidden mb-4">
                <div id="alert" class="p-4 rounded-lg">
                    <span id="alert-message"></span>
                </div>
            </div>

            <!-- Models Table -->
            <div class="bg-white rounded-lg shadow">
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Version</th>
                            <th class="px-6 py-3">Created Date</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Accuracy</th>
                            <th class="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="models-table-body">
                        <!-- Table content will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create Model Modal -->
        <div
            id="createModelModal"
            tabindex="-1"
            aria-hidden="true"
            class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"
        >
            <div class="relative p-4 w-full max-w-2xl max-h-full">
                <!-- Modal content -->
                <div class="relative bg-white rounded-lg shadow">
                    <!-- Modal header -->
                    <div class="flex items-center justify-between p-4 border-b rounded-t">
                        <h3 class="text-xl font-semibold text-gray-900">Configure and Train Model</h3>
                        <button
                            type="button"
                            class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center"
                            data-modal-hide="createModelModal"
                        >
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                <path
                                    stroke="currentColor"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
                                />
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                    </div>

                    <!-- Modal body -->
                    <div class="p-6 space-y-6">
                        <form id="model-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2"> Embedding Dimension: </label>
                                <input
                                    type="number"
                                    name="embedding_dim"
                                    min="1"
                                    max="100"
                                    value="16"
                                    required
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                />
                            </div>

                            <div id="layer-config" class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold">Layers</h4>
                                    <button
                                        type="button"
                                        onclick="addLayer()"
                                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"
                                    >
                                        Add Layer
                                    </button>
                                </div>
                                <div id="layers-container"></div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2"> Learning Rate: </label>
                                <input
                                    type="number"
                                    name="learning_rate"
                                    step="0.001"
                                    value="0.001"
                                    required
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                />
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2"> Batch Size: </label>
                                <input
                                    type="number"
                                    name="batch_size"
                                    value="64"
                                    required
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                />
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2"> Epochs: </label>
                                <input
                                    type="number"
                                    name="epochs"
                                    value="200"
                                    required
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                />
                            </div>
                        </form>

                        <!-- Progress container -->
                        <div id="progress-container" class="hidden">
                            <div class="mb-2 text-sm font-medium text-gray-700">Training Progress</div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="progress-status" class="mt-2 text-sm text-gray-600 text-center">0%</div>
                        </div>

                        <!-- Message container -->
                        <div id="response-message" class="hidden mt-4 p-4 rounded-lg"></div>
                    </div>

                    <!-- Modal footer -->
                    <div class="flex items-center justify-end p-6 space-x-2 border-t border-gray-200 rounded-b">
                        <button
                            type="button"
                            onclick="trainModel()"
                            id="train-button"
                            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center"
                        >
                            Train Model
                        </button>
                        <button
                            type="button"
                            data-modal-hide="createModelModal"
                            class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let trainingInProgress = false;

            function addLayer() {
                const layersContainer = document.getElementById("layers-container");
                const layerDiv = document.createElement("div");
                layerDiv.classList.add("layer", "mb-4", "p-4", "border", "rounded-lg", "bg-gray-50");

                layerDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Layer Type:</label>
                            <select name="layer_type" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dense">Dense</option>
                                <option value="LSTM">LSTM</option>
                                <option value="Dropout">Dropout</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Neurons/Rate:</label>
                            <input type="number" name="neurons_rate" required
                                   class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                `;

                layersContainer.appendChild(layerDiv);
            }

            window.addEventListener("beforeunload", function (e) {
                if (trainingInProgress) {
                    const confirmationMessage = "Training is in progress. Are you sure you want to leave?";
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });

            function showMessage(message, isError = false) {
                const messageElement = document.getElementById("response-message");
                messageElement.textContent = message;
                messageElement.classList.remove("hidden", "bg-green-100", "text-green-800", "bg-red-100", "text-red-800");
                messageElement.classList.add(isError ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800");
            }

            function setFormEnabled(enabled) {
                const form = document.getElementById("model-form");
                const trainButton = document.getElementById("train-button");
                const elements = form.elements;

                for (let element of elements) {
                    element.disabled = !enabled;
                }
                trainButton.disabled = !enabled;
            }

            async function trainModel() {
                const form = document.getElementById("model-form");
                const formData = new FormData(form);
                const progressContainer = document.getElementById("progress-container");
                const progressBar = document.getElementById("progress");
                const progressStatus = document.getElementById("progress-status");

                // Show progress and disable form
                progressContainer.classList.remove("hidden");
                setFormEnabled(false);
                trainingInProgress = true;

                try {
                    const layerConfigs = Array.from(document.querySelectorAll("#layers-container .layer")).map((layerDiv) => ({
                        type: layerDiv.querySelector('select[name="layer_type"]').value,
                        neurons: parseFloat(layerDiv.querySelector('input[name="neurons_rate"]').value),
                    }));

                    const response = await fetch("/train", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            embedding_dim: parseInt(formData.get("embedding_dim")),
                            layers: layerConfigs,
                            learning_rate: parseFloat(formData.get("learning_rate")),
                            batch_size: parseInt(formData.get("batch_size")),
                            epochs: parseInt(formData.get("epochs")),
                        }),
                    });

                    const reader = response.body.getReader();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const text = new TextDecoder().decode(value);
                        const matches = text.match(/data:(.*)/g);

                        if (matches) {
                            matches.forEach((match) => {
                                try {
                                    const data = JSON.parse(match.replace("data:", ""));
                                    const progress = data.progress;
                                    progressBar.style.width = `${progress}%`;
                                    progressStatus.textContent = `${progress}%`;

                                    if (progress >= 100) {
                                        finishTraining("Model training completed successfully!");
                                    }
                                } catch (e) {
                                    console.error("Error parsing progress data:", e);
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error("Training error:", error);
                    finishTraining("An error occurred during training.", true);
                }
            }

            function finishTraining(message, isError = false) {
                trainingInProgress = false;
                setFormEnabled(true);
                showMessage(message, isError);

                if (!isError) {
                    // Reload models table after successful training
                    fetchAndDisplayModels();
                    // Hide modal after short delay
                    setTimeout(() => {
                        const modal = document.getElementById("createModelModal");
                        if (typeof modal.hide === "function") {
                            modal.hide();
                        }
                    }, 2000);
                }
            }

            // Add initial layer on modal open
            document.addEventListener("DOMContentLoaded", function () {
                const modal = document.getElementById("createModelModal");
                modal.addEventListener("shown.bs.modal", function () {
                    const layersContainer = document.getElementById("layers-container");
                    if (layersContainer.children.length === 0) {
                        addLayer();
                    }
                });
            });

            // Utility function to format date
            function formatDate(dateString) {
                return new Date(dateString).toLocaleString();
            }

            // Function to show alert
            function showAlert(message, type) {
                const alertContainer = document.getElementById("alert-container");
                const alert = document.getElementById("alert");
                const alertMessage = document.getElementById("alert-message");

                alertContainer.classList.remove("hidden");
                alert.className = "p-4 rounded-lg";
                alert.classList.add(type === "success" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800");
                alertMessage.textContent = message;

                setTimeout(() => {
                    alertContainer.classList.add("hidden");
                }, 3000);
            }

            // Function to fetch and display models
            async function fetchAndDisplayModels() {
                try {
                    const response = await fetch("/models");
                    const data = await response.json();
                    const tableBody = document.getElementById("models-table-body");
                    tableBody.innerHTML = "";

                    // Combine active model and other models
                    const allModels = [...data.models];
                    if (data.active_model) {
                        allModels.unshift({
                            version: "Current",
                            backup_date: data.active_model.training_date,
                            status: "active",
                            training_metrics: data.active_model.metrics,
                        });
                    }

                    allModels.forEach((model) => {
                        const accuracy = model.training_metrics?.final_accuracy
                            ? (model.training_metrics.final_accuracy * 100).toFixed(2) + "%"
                            : "N/A";

                        const row = document.createElement("tr");
                        row.className = "border-t";
                        row.innerHTML = `
                                    <td class="px-6 py-4">${model.version}</td>
                                    <td class="px-6 py-4">${formatDate(model.backup_date)}</td>
                                    <td class="px-6 py-4">
                                        <span class="model-status ${model.status === "active" ? "status-active" : "status-inactive"}">
                                            ${model.status === "active" ? "Active" : "Inactive"}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">${accuracy}</td>
                                    <td class="px-6 py-4">
                                        ${
                                            model.status !== "active"
                                                ? `
                                            <button onclick="viewModelDetails('${model.version}')"
                                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                                View Details
                                            </button>
                                            <button onclick="restoreModel('${model.version}')"
                                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                                Restore
                                            </button>
                                            <button onclick="deleteModel('${model.version}')"
                                                    class="text-red-600 hover:text-red-800">
                                                Delete
                                            </button>
                                        `
                                                : ""
                                        }
                                    </td>
                                `;
                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    showAlert("Failed to fetch models", "error");
                }
            }
            async function viewModelDetails(version) {
                try {
                    const response = await fetch(`/version-history/${version}`);
                    const data = await response.json();

                    if (response.ok) {
                        // Display the training history in a modal or other UI element
                        displayTrainingHistory(data);
                    } else {
                        throw new Error(data.error || "Failed to fetch model details");
                    }
                } catch (error) {
                    showAlert(error.message, "error");
                }
            }

            function displayTrainingHistory(data) {
                // Create modal HTML
                const modalHtml = `
                                    <div class="modal fixed z-10 inset-0 overflow-y-auto" id="training-modal">
                                        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
                                            <!-- Overlay -->
                                            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                                            
                                            <!-- Modal Content -->
                                            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
                                                <!-- Modal Body -->
                                                <div class="bg-white px-6 pt-6 pb-6">
                                                    <!-- Header -->
                                                    <div class="flex justify-between items-center mb-6">
                                                        <h3 class="text-2xl font-bold text-gray-900">Model Training Details</h3>
                                                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-500 p-2 rounded-full hover:bg-gray-100">
                                                            <span class="sr-only">Close</span>
                                                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    </div>

                                                    <!-- Content Sections -->
                                                    <div class="space-y-6">
                                                        <!-- Model Configuration -->
                                                        <div class="bg-gray-50 rounded-lg p-6">
                                                            <h4 class="text-lg font-semibold mb-4">Model Configuration</h4>
                                                            <div class="grid grid-cols-2 gap-6">
                                                                <div class="space-y-2">
                                                                    <p><strong>Batch Size:</strong> ${data.model_config.batch_size}</p>
                                                                    <p><strong>Embedding Dimension:</strong> ${
                                                                        data.model_config.embedding_dim
                                                                    }</p>
                                                                    <p><strong>Learning Rate:</strong> ${
                                                                        data.model_config.learning_rate
                                                                    }</p>
                                                                    <p><strong>Epochs:</strong> ${data.model_config.epochs}</p>
                                                                </div>
                                                                <div class="space-y-2">
                                                                    <p><strong>Vocabulary Size:</strong> ${data.model_config.vocab_size}</p>
                                                                    <p><strong>Output Length:</strong> ${
                                                                        data.model_config.output_length
                                                                    }</p>
                                                                    <p><strong>Training Date:</strong> ${new Date(
                                                                        data.training_date
                                                                    ).toLocaleString()}</p>
                                                                </div>
                                                            </div>

                                                            <!-- Layer Configuration -->
                                                            <div class="mt-4">
                                                                <h5 class="font-semibold mb-3">Layer Configuration:</h5>
                                                                <div class="space-y-2">
                                                                    ${data.model_config.layers
                                                                        .map(
                                                                            (layer, index) => `
                                                                        <div class="bg-white p-3 rounded border">
                                                                            <p>Layer ${index + 1}: ${layer.type} (${
                                                                                layer.type === "Dropout" ? "Rate" : "Neurons"
                                                                            }: ${layer.neurons})</p>
                                                                        </div>
                                                                    `
                                                                        )
                                                                        .join("")}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Training Summary -->
                                                        <div>
                                                            <h4 class="text-lg font-semibold mb-4">Training Summary</h4>
                                                            <div class="grid grid-cols-2 gap-6">
                                                                <div class="bg-blue-50 p-6 rounded-lg space-y-2">
                                                                    <p><strong>Final Accuracy:</strong> ${(
                                                                        data.training_history.final_accuracy * 100
                                                                    ).toFixed(2)}%</p>
                                                                    <p><strong>Best Accuracy:</strong> ${(
                                                                        data.training_history.best_accuracy * 100
                                                                    ).toFixed(2)}%</p>
                                                                    <p><strong>Best Epoch:</strong> ${data.training_history.best_epoch}</p>
                                                                    <p><strong>Final Loss:</strong> ${data.training_history.final_loss.toFixed(
                                                                        4
                                                                    )}</p>
                                                                </div>
                                                                <div class="bg-green-50 p-6 rounded-lg space-y-2">
                                                                    <p><strong>Total Duration:</strong> ${
                                                                        data.training_history.total_duration
                                                                    }</p>
                                                                    <p><strong>Steps per Epoch:</strong> ${
                                                                        data.training_history.steps_per_epoch
                                                                    }</p>
                                                                    <p><strong>Total Steps:</strong> ${
                                                                        data.training_history.total_steps
                                                                    }</p>
                                                                    <p><strong>Start Time:</strong> ${new Date(
                                                                        data.training_history.start_time
                                                                    ).toLocaleString()}</p>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Epoch Details Table -->
                                                        <div>
                                                            <h4 class="text-lg font-semibold mb-4">Epoch Details</h4>
                                                            <div class="border rounded-lg shadow-sm overflow-hidden">
                                                                <div class="epoch-table-container">
                                                                    <table class="min-w-full divide-y divide-gray-200 table-fixed">
                                                                        <thead class="bg-gray-50 sticky top-0 z-10">
                                                                            <tr>
                                                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Epoch</th>
                                                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Accuracy</th>
                                                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loss</th>
                                                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Steps</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody class="bg-white divide-y divide-gray-200">
                                                                            ${data.training_history.epochs
                                                                                .map(
                                                                                    (epoch, index) => `
                                                                                    <tr class="hover:bg-gray-50 ${
                                                                                        index >= 20 ? "scrollable-row" : ""
                                                                                    }">
                                                                                        <td class="px-6 py-4 whitespace-nowrap">${
                                                                                            epoch.epoch_number
                                                                                        }</td>
                                                                                        <td class="px-6 py-4 whitespace-nowrap">${(
                                                                                            epoch.metrics.accuracy * 100
                                                                                        ).toFixed(2)}%</td>
                                                                                        <td class="px-6 py-4 whitespace-nowrap">${epoch.metrics.loss.toFixed(
                                                                                            4
                                                                                        )}</td>
                                                                                        <td class="px-6 py-4 whitespace-nowrap">${
                                                                                            epoch.duration
                                                                                        }</td>
                                                                                        <td class="px-6 py-4 whitespace-nowrap">${
                                                                                            epoch.steps.length
                                                                                        }</td>
                                                                                    </tr>
                                                                                `
                                                                                )
                                                                                .join("")}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Training Progress Chart -->
                                                        <div>
                                                            <h4 class="text-lg font-semibold mb-4">Training Progress</h4>
                                                            <div class="border rounded-lg p-4">
                                                                <div style="position: relative; height: 400px; width: 100%;">
                                                                    <canvas id="training-chart"></canvas>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal Footer -->
                                                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse">
                                                    <button 
                                                        type="button" 
                                                        onclick="closeModal()" 
                                                        class="w-full inline-flex justify-center rounded-lg px-4 py-2 bg-blue-600 text-white text-base font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                                                    >
                                                        Close
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;

                // Add modal to document
                document.body.insertAdjacentHTML("beforeend", modalHtml);

                const styles = `
                                    <style>
                                        .epoch-table-container {
                                            height: 600px; /* Shows approximately 20 rows */
                                            overflow-y: auto;
                                            overflow-x: hidden;
                                        }

                                        .epoch-table-container thead {
                                            position: sticky;
                                            top: 0;
                                            z-index: 10;
                                            background-color: #f9fafb;
                                            border-bottom: 1px solid #e5e7eb;
                                        }

                                        /* Custom scrollbar styling */
                                        .epoch-table-container::-webkit-scrollbar {
                                            width: 8px;
                                        }

                                        .epoch-table-container::-webkit-scrollbar-track {
                                            background: #f1f1f1;
                                            border-radius: 4px;
                                        }

                                        .epoch-table-container::-webkit-scrollbar-thumb {
                                            background: #cbd5e1;
                                            border-radius: 4px;
                                            border: 2px solid #f1f1f1;
                                        }

                                        .epoch-table-container::-webkit-scrollbar-thumb:hover {
                                            background: #94a3b8;
                                        }

                                        /* Styling for rows after the first 20 */
                                        .scrollable-row {
                                            opacity: 0.95;
                                        }

                                        .scrollable-row:hover {
                                            opacity: 1;
                                            background-color: #f9fafb;
                                        }

                                        /* Ensure table header stays visible */
                                        .sticky-header {
                                            position: sticky;
                                            top: 0;
                                            background: #f9fafb;
                                            z-index: 10;
                                        }
                                    </style>
                                `;

                document.head.insertAdjacentHTML("beforeend", styles);

                // Wait for the DOM to be fully updated
                setTimeout(() => {
                    createTrainingChart(data);
                }, 100);
            }

            function createTrainingChart(data) {
                const ctx = document.getElementById("training-chart");

                if (!ctx) {
                    console.error("Cannot find canvas element");
                    return;
                }

                // Prepare the data
                const chartData = data.training_history.epochs.map((epoch) => ({
                    epoch: epoch.epoch_number,
                    accuracy: epoch.metrics.accuracy * 100,
                    loss: epoch.metrics.loss,
                }));

                // Create the chart
                try {
                    const chart = new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: chartData.map((d) => `Epoch ${d.epoch}`),
                            datasets: [
                                {
                                    label: "Accuracy (%)",
                                    data: chartData.map((d) => d.accuracy),
                                    borderColor: "rgb(75, 192, 192)",
                                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                                    yAxisID: "y",
                                    tension: 0.1,
                                },
                                {
                                    label: "Loss",
                                    data: chartData.map((d) => d.loss),
                                    borderColor: "rgb(255, 99, 132)",
                                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                                    yAxisID: "y1",
                                    tension: 0.1,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: "index",
                                intersect: false,
                            },
                            stacked: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: "Training Progress",
                                },
                            },
                            scales: {
                                y: {
                                    type: "linear",
                                    display: true,
                                    position: "left",
                                    title: {
                                        display: true,
                                        text: "Accuracy (%)",
                                    },
                                    min: 0,
                                    max: 100,
                                },
                                y1: {
                                    type: "linear",
                                    display: true,
                                    position: "right",
                                    title: {
                                        display: true,
                                        text: "Loss",
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                },
                            },
                        },
                    });
                } catch (error) {
                    console.error("Error creating chart:", error);
                }
            }

            function closeModal() {
                const modal = document.querySelector("#training-modal");
                if (modal) {
                    // Destroy the chart before removing the modal
                    const chart = Chart.getChart("training-chart");
                    if (chart) {
                        chart.destroy();
                    }
                    modal.remove();
                }
            }

            // Function to restore model
            async function restoreModel(version) {
                try {
                    const response = await fetch(`/models/${version}/activate`, {
                        method: "POST",
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showAlert("Model restored successfully", "success");
                        await fetchAndDisplayModels();
                    } else {
                        throw new Error(data.error || "Failed to restore model");
                    }
                } catch (error) {
                    showAlert(error.message, "error");
                }
            }

            // Function to delete model
            async function deleteModel(version) {
                if (!confirm("Are you sure you want to delete this model?")) {
                    return;
                }

                try {
                    const response = await fetch(`/models/${version}`, {
                        method: "DELETE",
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showAlert("Model deleted successfully", "success");
                        await fetchAndDisplayModels();
                    } else {
                        throw new Error(data.error || "Failed to delete model");
                    }
                } catch (error) {
                    showAlert(error.message, "error");
                }
            }

            // Initial load
            document.addEventListener("DOMContentLoaded", fetchAndDisplayModels);
        </script>
    </body>
</html>
