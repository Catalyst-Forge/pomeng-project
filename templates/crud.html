<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Intent CRUD</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            table,
            th,
            td {
                border: 1px solid black;
            }
            th,
            td {
                padding: 8px;
                text-align: left;
            }
            form {
                margin-bottom: 20px;
            }
            form input,
            form button {
                padding: 8px;
                margin: 5px 0;
                width: 100%;
            }
            form button {
                width: auto;
            }
            /* The Modal (background) */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0, 0, 0); /* Fallback color */
                background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
                padding-top: 60px;
            }

            /* Modal Content/Box */
            .modal-content {
                background-color: #fefefe;
                margin: 5% auto; /* 15% from the top and centered */
                padding: 20px;
                border: 1px solid #888;
                width: 80%; /* Could be more or less, depending on screen size */
                max-width: 500px; /* Limit the width */
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            /* The Close Button */
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

            /* Form input styles */
            .modal-content input[type="text"] {
                width: 100%;
                padding: 10px;
                margin: 8px 0;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            .modal-content button {
                background-color: #4caf50;
                color: white;
                padding: 10px 20px;
                margin: 10px 0;
                border: none;
                cursor: pointer;
                width: 100%;
                border-radius: 5px;
            }

            .modal-content button:hover {
                background-color: #45a049;
            }
        </style>
    </head>
    <body>
        <h1>CRUD Intent <button id="create-btn" style="margin-left: 10px">Create Intent</button></h1>

        <!-- List of Intents -->
        <h2>List of Intents</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tag</th>
                    <th>Patterns</th>
                    <th>Responses</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for intent in intents %}
                <tr>
                    <td>{{ intent.id }}</td>
                    <td>{{ intent.tag }}</td>
                    <td>{{ intent.patterns }}</td>
                    <td>{{ intent.responses }}</td>
                    <td>
                        <button
                            type="button"
                            onclick="openUpdateModal('{{ intent.id }}', '{{ intent.tag }}', '{{ intent.patterns }}', '{{ intent.responses }}')"
                        >
                            Update
                        </button>
                        <form action="/delete/{{ intent.id }}" method="POST" style="display: inline-block">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this intent?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Create Intent Modal -->
        <div id="createModal" class="modal">
            <div class="modal-content">
                <span class="close" id="close-create-modal">&times;</span>
                <h2>Create New Intent</h2>
                <form id="create-form" action="/create" method="POST">
                    <label for="create-tag">Tag:</label>
                    <input type="text" id="create-tag" name="tag" required />

                    <label for="create-patterns">Patterns:</label>
                    <div id="create-patterns-list" class="patterns-list">
                        <div class="pattern-input">
                            <input type="text" name="patterns[]" placeholder="Enter pattern" required />
                            <button type="button" class="remove-pattern" onclick="removePattern(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" id="add-create-pattern">Add Pattern</button>

                    <label for="create-responses">Responses:</label>
                    <input type="text" id="create-responses" name="responses" required />

                    <input type="hidden" id="create-patterns-hidden" name="patterns_hidden" />
                    <button type="submit">Add Intent</button>
                </form>
            </div>
        </div>

        <!-- Update Intent Modal -->
        <div id="updateModal" class="modal">
            <div class="modal-content">
                <span class="close" id="close-update-modal">&times;</span>
                <h2>Update Intent</h2>
                <form id="update-form" action="/update/" method="POST">
                    <input type="hidden" id="intent-id" name="id" value="" />
                    <label for="update-tag">Tag</label>
                    <input type="text" id="update-tag" name="tag" value="" required />

                    <label for="update-patterns">Patterns</label>
                    <input type="text" id="update-patterns" name="patterns" value="" required />

                    <label for="update-responses">Responses</label>
                    <input type="text" id="update-responses" name="responses" value="" required />

                    <button type="submit">Update Intent</button>
                </form>
            </div>
        </div>

        <script>
            function removePattern(button) {
                const patternDiv = button.parentElement;
                patternDiv.remove();
            }

            window.onload = function () {
                document.getElementById("create-btn").onclick = function () {
                    document.getElementById("createModal").style.display = "block";
                };

                // Handle add pattern button in create modal
                document.getElementById("add-create-pattern").onclick = function () {
                    const container = document.getElementById("create-patterns-list");
                    const div = document.createElement("div");
                    div.classList.add("pattern-input");
                    const input = document.createElement("input");
                    input.type = "text";
                    input.name = "patterns[]";
                    input.placeholder = "Enter pattern";
                    input.required = true;
                    const removeBtn = document.createElement("button");
                    removeBtn.type = "button";
                    removeBtn.classList.add("remove-pattern");
                    removeBtn.textContent = "Remove";
                    removeBtn.onclick = function () {
                        removePattern(removeBtn);
                    };
                    div.appendChild(input);
                    div.appendChild(removeBtn);
                    container.appendChild(div);
                };

                // Handle submit for create intent
                // Handle submit for create intent
                document.getElementById("create-form").onsubmit = function () {
                    const inputs = document.querySelectorAll('#create-patterns-list input[name="patterns[]"]');
                    const patterns = Array.from(inputs)
                        .map((input) => input.value)
                        .filter((pattern) => pattern.trim() !== "") // Filter out empty patterns
                        .join(","); // Join patterns with a comma

                    console.log("Collected Patterns:", patterns); // Debugging line

                    document.getElementById("create-patterns-hidden").value = patterns; // Set hidden input value
                };

                // Handle close for create modal
                document.getElementById("close-create-modal").onclick = function () {
                    document.getElementById("createModal").style.display = "none";
                };

                // Handle close for update modal
                document.getElementById("close-update-modal").onclick = function () {
                    document.getElementById("updateModal").style.display = "none";
                };

                // Open update modal with existing data
                window.openUpdateModal = function (id, tag, patterns, responses) {
                    document.getElementById("intent-id").value = id;
                    document.getElementById("update-tag").value = tag;
                    document.getElementById("update-patterns").value = patterns; // You can add logic to show patterns better
                    document.getElementById("update-responses").value = responses;
                    document.getElementById("update-form").action = "/update/" + id; // Set correct action URL
                    document.getElementById("updateModal").style.display = "block";
                };

                // Close modal if clicking outside of it
                window.onclick = function (event) {
                    if (event.target == document.getElementById("createModal")) {
                        document.getElementById("createModal").style.display = "none";
                    } else if (event.target == document.getElementById("updateModal")) {
                        document.getElementById("updateModal").style.display = "none";
                    }
                };

                // Handle submit for update form
                document.getElementById("update-form").onsubmit = function (event) {
                    event.preventDefault(); // Prevent default submission
                    const updateForm = document.getElementById("update-form");
                    updateForm.submit();
                };
            };
        </script>
    </body>
</html>
